# Books API

Express.js backend API for books data with Supabase and JWT authentication.

## Features

- RESTful API for managing books
- Search by genres, year, and author
- JWT authentication with role-based access control
- Supabase PostgreSQL database
- Docker support

## Tech Stack   

- Node.js 18+
- Express.js
- Supabase (PostgreSQL)
- JWT (jsonwebtoken)
- Docker

## Prerequisites

- Node.js 18+
- Docker (optional)
- Supabase account

## Installation

1. Clone the repository:
```bash
git clone <your-repo-url>
cd TubesTST-II3160
```

2. Install dependencies:
```bash
npm install
```

3. Create `.env` file from example:
```bash
cp .env.example .env
```

4. Update `.env` with your Supabase credentials:
```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
JWT_SECRET=your-very-secret-jwt-key-change-this-in-production
PORT=3000
```

5. Set up Supabase table and policies (see below)

## Supabase Setup

Run this SQL in Supabase SQL Editor:

```sql
-- Create books table
CREATE TABLE books (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  title TEXT NOT NULL,
  genres TEXT NOT NULL,
  authors TEXT NOT NULL,
  year INT NOT NULL
);

-- Enable RLS and add policies
ALTER TABLE books ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow all operations" ON books
FOR ALL USING (true) WITH CHECK (true);

-- Reset sequence to match existing data
SELECT setval('books_id_seq', (SELECT MAX(id) FROM books));
```

## Running the Application

### Without Docker:
```bash
npm start
```

### With Docker:
```bash
# Build and run
docker-compose up --build

# Run in background
docker-compose up -d

# View logs
docker-compose logs -f

# Stop
docker-compose down
```

## Authentication

This API uses JWT (JSON Web Tokens) for authentication with role-based access control.

### Roles:
- **member**: Can read books (GET requests only)
- **librarian**: Full access (GET, POST, PUT, DELETE)

### Generate Test Tokens:
```bash
npm run generate-tokens
```

This will generate JWT tokens for both roles with test commands.

## API Endpoints

| Method | Endpoint | Access | Description |
|--------|----------|--------|-------------|
| GET | `/api/books` | member, librarian | Get all books |
| GET | `/api/books/:id` | member, librarian | Get single book by ID |
| GET | `/api/books/genres/:genres` | member, librarian | Search books by genres |
| GET | `/api/books/year/:year` | member, librarian | Search books by year |
| GET | `/api/books/author/:author` | member, librarian | Search books by author |
| GET | `/api/stats` | member, librarian | Get books statistics |
| POST | `/api/books` | librarian only | Create new book |
| PUT | `/api/books/:id` | librarian only | Update book |
| DELETE | `/api/books/:id` | librarian only | Delete book |

## Testing

All requests require JWT token in Authorization header:

### GET requests:
```powershell
# Get all books
Invoke-RestMethod -Uri "http://localhost:3000/api/books" -Headers @{Authorization="Bearer YOUR_TOKEN"}

# Search by genre
Invoke-RestMethod -Uri "http://localhost:3000/api/books/genres/Fiction" -Headers @{Authorization="Bearer YOUR_TOKEN"}
```

### POST request (librarian only):
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/books" -Method POST -Headers @{Authorization="Bearer YOUR_LIBRARIAN_TOKEN"} -ContentType "application/json" -Body '{"title":"New Book","genres":"Fiction","authors":"John Doe","year":2025}'
```

### PUT request (librarian only):
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/books/1" -Method PUT -Headers @{Authorization="Bearer YOUR_LIBRARIAN_TOKEN"} -ContentType "application/json" -Body '{"title":"Updated","genres":"Drama","authors":"Jane Doe","year":2024}'
```

### DELETE request (librarian only):
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/books/1" -Method DELETE -Headers @{Authorization="Bearer YOUR_LIBRARIAN_TOKEN"}
```

## Error Responses

### 401 Unauthorized:
```json
{
  "error": "TidakTerautentikasi",
  "message": "Token Bearer tidak ditemukan. Tambahkan Authorization: Bearer <token>."
}
```

### 403 Forbidden:
```json
{
  "error": "AksesDitolak",
  "message": "Anda tidak memiliki izin untuk mengakses endpoint ini."
}
```

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `SUPABASE_URL` | Your Supabase project URL | Yes |
| `SUPABASE_KEY` | Your Supabase anon/public key | Yes |
| `JWT_SECRET` | Secret key for JWT signing | Yes |
| `PORT` | Server port (default: 3000) | No |

## Project Structure

```
.
├── server.js              # Main application file
├── generate-tokens.js     # JWT token generator for testing
├── generate_db.py         # Python script to generate fake book data
├── package.json           # Node.js dependencies
├── Dockerfile            # Docker configuration
├── docker-compose.yml    # Docker Compose configuration
├── .env.example          # Example environment variables
├── .gitignore            # Git ignore rules
├── .dockerignore         # Docker ignore rules
└── README.md             # This file
```

## License

MIT
